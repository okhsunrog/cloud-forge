---
- name: Install Nginx
  apt:
    name: nginx
    state: present
    update_cache: yes

- name: Copy nginx.conf
  copy:
    src: nginx.conf
    dest: "/etc/nginx/nginx.conf"
    owner: root
    group: root
    mode: '0644'
  notify: Reload Nginx

- name: Create SSL configuration files
  copy:
    dest: "/etc/letsencrypt/options-ssl-nginx.conf"
    content: |
      ssl_session_cache shared:le_nginx_SSL:1m;
      ssl_session_timeout 1440m;
      ssl_protocols TLSv1.2 TLSv1.3;
      ssl_prefer_server_ciphers off;
      ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384";

- name: Generate DH parameters
  command: openssl dhparam -out /etc/letsencrypt/ssl-dhparams.pem 2048
  args:
    creates: /etc/letsencrypt/ssl-dhparams.pem

- name: Remove default site configuration
  file:
    path: "/etc/nginx/sites-enabled/default"
    state: absent
  notify: Reload Nginx

- name: Ensure sites-available directory exists
  file:
    path: "/etc/nginx/sites-available"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Ensure sites-enabled directory exists
  file:
    path: "/etc/nginx/sites-enabled"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Deploy Nginx site configurations
  template:
    src: "{{ item }}.conf.j2"
    dest: "/etc/nginx/sites-available/{{ item }}.conf"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ domains.nginx.keys() | list }}"
  loop_control:
    label: "{{ item }}"
  notify: Reload Nginx

- name: Enable Nginx site configurations
  file:
    src: "/etc/nginx/sites-available/{{ item }}.conf"
    dest: "/etc/nginx/sites-enabled/{{ item }}.conf"
    state: link
  loop: "{{ domains.nginx.keys() | list }}"
  loop_control:
    label: "{{ item }}"
  notify: Reload Nginx

- name: Ensure Nginx is started and enabled
  service:
    name: nginx
    state: started
    enabled: yes
