---
- name: Install Certbot and dependencies
  apt:
    name:
      - certbot
      - python3-certbot
      - python3-certbot-nginx
      - python3-openssl
    state: present
    update_cache: yes

- name: Check if certificates exist and are up to date
  shell: |
    certbot certificates 2>/dev/null | grep "VALID:" | grep -v "EXPIRING SOON" || true
  register: cert_status
  changed_when: false

- name: Check if nginx is running
  service_facts:
  register: services_state

- name: Set nginx running fact
  set_fact:
    nginx_running: "{{ 'nginx.service' in services_state.ansible_facts.services and services_state.ansible_facts.services['nginx.service'].state == 'running' }}"

- name: Stop nginx if running
  systemd:
    name: nginx
    state: stopped
  when: 
    - cert_status.rc != 0
    - nginx_running

- name: Debug variables
  debug:
    msg: 
      - "Email: {{ email }}"
      - "Domains: {{ all_domains }}"

- name: Check certbot path
  stat:
    path: /etc/letsencrypt/live
  register: cert_path
  
- name: Show certificate path status
  debug:
    var: cert_path

- name: Obtain certificates
  shell: certbot certonly --standalone --non-interactive --agree-tos -m {{ email }} -d {{ all_domains | join(',') }}
  when: cert_status.rc != 0

- name: Start nginx if it was running
  systemd:
    name: nginx
    state: started
  when: 
    - cert_status.rc != 0
    - nginx_running
